<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <script src="./javascript/Leaflet.MakiMarkers.js"></script>
    <script src="https://api4.windy.com/assets/libBoot.js"></script>

		<style media="screen">
			body { margin:0; padding:0; }
      html, body, #windy { height: 100%; width: 100%; }
		</style>

    <title>STWA Neusiedlersee</title>
  </head>
  <body>
		<div id='windy'></div>
		<script>
      L.MakiMarkers.accessToken = 'pk.eyJ1IjoibWxvY2hlciIsImEiOiJfZWVkY0ZVIn0.88USuqZS5tBYfHNEisWaKw';

      var icon = {

      } = L.MakiMarkers.icon({icon: "lighthouse", color: "#f8f9fa", size: "m"});

      var stwa = {
        url: 'https://uqj85armfl.execute-api.eu-central-1.amazonaws.com/default/stwa',
        marker: {},
        icons: {
          standby: L.MakiMarkers.icon({icon: "lighthouse", color: "#28a745", size: "m"}),
          advance_warning: L.MakiMarkers.icon({icon: "lighthouse", color: "#ffc107", size: "m"}),
          gale_warning: L.MakiMarkers.icon({icon: "lighthouse", color: "#dc3545", size: "m"}),
          out_of_order: L.MakiMarkers.icon({icon: "lighthouse", color: "#343a40", size: "m"}),
          default: L.MakiMarkers.icon({icon: "lighthouse", color: "#f8f9fa", size: "m"})
        }
      }
      function updateSTWA(map) {
        console.log("Updating STWA data...");
        fetch(stwa.url)
          .then(response => response.json())
          .then(data => {
            stwa.data = JSON.parse(data);
            for (let [station, data] of Object.entries(stwa.data.stations)) {
              switch (data.state) {
                case 'standby':
                  icon = stwa.icons.standby;
                  state = 'Standby';
                  break;
                case 'advance_warning':
                  icon = stwa.icons.advance_warning;
                  state = 'Advance Warning';
                  break;
                case 'gale_warning':
                  icon = stwa.icons.gale_warning;
                  state = 'Gale Warning';
                  break;
                case 'out_of_order':
                  icon = stwa.icons.out_of_order;
                  state = 'Out of Order';
                default:
                  icon = stwa.icons.default;
                  state = 'Unknown';
              }

              var popup = new L.Popup({
                  closeButton: false
                })
                .setContent(`<strong>${data.name}</strong><br />${state}`);

              var marker = new L.Marker(data.coordinates.reverse(), { icon: icon })
                .bindPopup(popup);

              if (stwa.marker[station]) {
                stwa.marker[station].remove();
              }
              stwa.marker[station] = marker;
              stwa.marker[station].addTo(map);
            }
          });
      }

      const options = {
        key: 'H13QqEQ8aCJtB1acMyQzTcobaebzNXhj',
        verbose: true,
        lat: 47.8650,
        lon: 16.7776,
        zoom: 10,
      };

      // Initialize Windy API
      windyInit(options, windyAPI => {
        const { map } = windyAPI;
        map.fitBounds([[16.6102,47.6294].reverse(),[16.9419,47.99].reverse()])
        updateSTWA(map);
        stwaUpdater = window.setInterval(updateSTWA.bind(null, map), 30000);
      });
		</script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
